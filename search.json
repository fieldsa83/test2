[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "",
    "section": "",
    "text": "#| echo: false #| warning: false #| message: false\n\n# Load libraries\nlibrary(quantmod)\n\nLoading required package: xts\n\n\nLoading required package: zoo\n\n\n\nAttaching package: 'zoo'\n\n\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n\n\nLoading required package: TTR\n\n\nRegistered S3 method overwritten by 'quantmod':\n  method            from\n  as.zoo.data.frame zoo \n\nlibrary(dplyr)\n\n\n######################### Warning from 'xts' package ##########################\n#                                                                             #\n# The dplyr lag() function breaks how base R's lag() function is supposed to  #\n# work, which breaks lag(my_xts). Calls to lag(my_xts) that you type or       #\n# source() into this session won't work correctly.                            #\n#                                                                             #\n# Use stats::lag() to make sure you're not using dplyr::lag(), or you can add #\n# conflictRules('dplyr', exclude = 'lag') to your .Rprofile to stop           #\n# dplyr from breaking base R's lag() function.                                #\n#                                                                             #\n# Code in packages is not affected. It's protected by R's namespace mechanism #\n# Set `options(xts.warn_dplyr_breaks_lag = FALSE)` to suppress this warning.  #\n#                                                                             #\n###############################################################################\n\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:xts':\n\n    first, last\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\nlibrary(plotly)\n\nLoading required package: ggplot2\n\n\n\nAttaching package: 'plotly'\n\n\nThe following object is masked from 'package:ggplot2':\n\n    last_plot\n\n\nThe following object is masked from 'package:stats':\n\n    filter\n\n\nThe following object is masked from 'package:graphics':\n\n    layout\n\n# Define current year\ncurrent_year &lt;- 2025\n\n# 1. Get Daily Data\ndf_hist_xts &lt;- getSymbols(\"^IXIC\", \n                          from = \"2008-01-01\", \n                          to = \"2025-12-31\",\n                          src = \"yahoo\", \n                          auto.assign = FALSE)\n\n# --- STEP A: Calculate the \"True\" Start Price for each Year ---\n# We need the close of the FIRST trading day to calculate accurate YTD\nyear_start_endpoints &lt;- endpoints(df_hist_xts, on = \"years\")\n# The 'endpoints' function returns the LAST index of the period. \n# To get the FIRST index of the year, we take the previous year's end + 1.\n# (We handle the first year manually or just use a grouping trick)\n\ndf_daily &lt;- data.frame(Date = index(df_hist_xts), coredata(df_hist_xts)) %&gt;%\n  mutate(Year = as.numeric(format(Date, \"%Y\")))\n\n# Group by Year and take the first available Close price\ndf_start_prices &lt;- df_daily %&gt;%\n  group_by(Year) %&gt;%\n  summarise(Start_Price = first(`IXIC.Adjusted`))\n\n# --- STEP B: Natural Weeks (1 to 52) ---\nweekly_idx &lt;- endpoints(df_hist_xts, on = \"weeks\")\ndf_weekly &lt;- df_hist_xts[weekly_idx, ]\ndf_weekly &lt;- data.frame(Date = index(df_weekly), coredata(df_weekly)) %&gt;%\n  mutate(\n    Year = as.numeric(format(Date, \"%Y\")),\n    Week = as.numeric(format(Date, \"%V\")) # ISO Week\n  ) %&gt;%\n  # Filter for standard weeks only. \n  # We exclude \"Week 53\" here because we will manually create the perfect one later.\n  # We also exclude the \"Week 1\" glitch where Dec 31 is labeled as Week 1.\n  filter(Week &lt;= 52, !(format(Date, \"%m\") == \"12\" & Week == 1))\n\n# --- STEP C: The \"Special\" Week 53 (Year End) ---\nyearly_idx &lt;- endpoints(df_hist_xts, on = \"years\")\ndf_yearend &lt;- df_hist_xts[yearly_idx, ]\ndf_yearend &lt;- data.frame(Date = index(df_yearend), coredata(df_yearend)) %&gt;%\n  mutate(\n    Year = as.numeric(format(Date, \"%Y\")),\n    Week = 53 # Hard-code this as the final bucket\n  )\n\n# --- STEP D: Combine and Calculate ---\n# Combine the natural weeks with the special year-end week\ndf_combined &lt;- bind_rows(df_weekly, df_yearend) %&gt;%\n  arrange(Year, Week)\n\n# Join with the Start Prices and calculate % Change\ndf_plot &lt;- left_join(df_combined, df_start_prices, by = \"Year\") %&gt;%\n  mutate(\n    change_from_year_start = ((`IXIC.Adjusted` / Start_Price) - 1) * 100\n  )\n\n# Split into historical and current\ndf_hist_plain &lt;- df_plot %&gt;% filter(Year &lt; current_year)\ndf_curr_year  &lt;- df_plot %&gt;% filter(Year == current_year)\n\n# Calculate Average\ndf_avg &lt;- df_hist_plain %&gt;%\n  group_by(Week) %&gt;%\n  summarise(avg_change = mean(change_from_year_start, na.rm = TRUE))\n\n# --- STEP E: Plotting ---\np &lt;- plot_ly()\n\n# Historical Years\np &lt;- add_trace(p, \n               data = df_hist_plain,\n               x = ~Week, \n               y = ~change_from_year_start,\n               type = 'scatter', \n               mode = 'lines', \n               split = ~Year, \n               line = list(color = 'grey', width = 1),\n               opacity = 0.3,\n               hoverinfo = \"text\",\n               text = ~paste(\"Year:\", Year, \"&lt;br&gt;Week:\", Week, \"&lt;br&gt;Change:\", round(change_from_year_start, 1),\"%\"),\n               showlegend = FALSE)\n\n# Current Year\nif(nrow(df_curr_year) &gt; 0) {\n  p &lt;- add_trace(p, \n                 data = df_curr_year,\n                 x = ~Week, \n                 y = ~change_from_year_start,\n                 type = 'scatter', \n                 mode = 'lines',\n                 line = list(color = '#336699', width = 3),\n                 name = as.character(current_year),\n                 hoverinfo = \"text\",\n                 text = ~paste(\"Year:\", Year, \"&lt;br&gt;Week:\", Week, \"&lt;br&gt;Change:\", round(change_from_year_start, 1),\"%\"))\n}\n\n# Average Line\np &lt;- add_trace(p, \n               data = df_avg,\n               x = ~Week, \n               y = ~avg_change,\n               type = 'scatter', \n               mode = 'lines',\n               line = list(color = 'darkred', width = 2, dash = 'dot'),\n               name = \"Avg Return\",\n               hoverinfo = \"text\",\n               text = ~paste(\"Average\", \"&lt;br&gt;Week:\", Week, \"&lt;br&gt;Change:\", round(avg_change, 1),\"%\"))\n\n# Layout\np &lt;- p %&gt;% layout(\n  xaxis = list(\n    title = \"Week (53 = Year End)\",\n    range = c(0.5, 53.5),\n    showgrid = FALSE,\n    tickvals = c(1, 10, 20, 30, 40, 50, 53),\n    ticktext = c(\"1\", \"10\", \"20\", \"30\", \"40\", \"50\", \"End\")\n  ),\n  yaxis = list(title = \"% Change\", showgrid = TRUE, gridcolor = \"#e5e5e5\"),\n  showlegend = TRUE,\n  legend = list(orientation = \"h\", y = 1.1),\n  plot_bgcolor = \"white\"\n) %&gt;% config(displayModeBar = FALSE)\n\np"
  }
]