
::: {style="font-size: 14pt;font-weight: bold;margin-bottom: 10px; margin-top: 20px"}
NASDAQ Weekly % Change Relative to Start of Year
:::


```{r}
#| echo: false
#| warning: false
#| message: false

# Load libraries
library(quantmod)
library(dplyr)
library(plotly)

# Define current year
current_year <- 2025

# 1. Get Daily Data
# Note: Ideally, fetch a few days from 2007 to get the perfect baseline for 2008.
df_hist_xts <- getSymbols("^IXIC", 
                          from = "2008-01-01", 
                          to = "2025-12-31",
                          src = "yahoo", 
                          auto.assign = FALSE)

# --- STEP A: Calculate the Standard YTD Baseline (Previous Year Close) ---
# Official YTD is calculated relative to the CLOSE of the LAST trading day of the PREVIOUS year.

# 1. Get the closing price of the last day of every year
yearly_ends <- endpoints(df_hist_xts, on = "years")
df_yearly_closes <- df_hist_xts[yearly_ends, ]

# 2. Create a reference table for baselines
df_baselines <- data.frame(
  Date = index(df_yearly_closes), 
  Close = coredata(df_yearly_closes)[, "IXIC.Adjusted"]
) %>%
  mutate(
    # The baseline for Year X is the close of Year X-1. 
    # So we add 1 to the Year column to map it to the NEXT year.
    Year = as.numeric(format(Date, "%Y")) + 1,
    Baseline_Price = IXIC.Adjusted
  ) %>%
  select(Year, Baseline_Price)

# 3. Handle the edge case: The first year (2008) has no "2007" data in this set.
# We default 2008's baseline to its first trading day open/close.
first_year <- min(as.numeric(format(index(df_hist_xts), "%Y")))
first_year_open <- as.numeric(first(df_hist_xts[, "IXIC.Adjusted"]))
if(!(first_year %in% df_baselines$Year)) {
  df_baselines <- rbind(df_baselines, data.frame(Year = first_year, Baseline_Price = first_year_open))
}

# --- STEP B: Natural Weeks (1 to 52) ---
weekly_idx <- endpoints(df_hist_xts, on = "weeks")
df_weekly <- df_hist_xts[weekly_idx, ]
df_weekly <- data.frame(Date = index(df_weekly), coredata(df_weekly)) %>%
  mutate(
    Year = as.numeric(format(Date, "%Y")),
    Week = as.numeric(format(Date, "%V")) 
  ) %>%
  # Filter out Week 53s and the "Week 1" ISO glitch (Dec 31 labeled as Week 1)
  filter(Week <= 52, !(format(Date, "%m") == "12" & Week == 1))

# --- STEP C: The "Special" Week 53 (Year End) ---
# This captures the exact final trading day of the year
yearly_idx <- endpoints(df_hist_xts, on = "years")
df_yearend <- df_hist_xts[yearly_idx, ]
df_yearend <- data.frame(Date = index(df_yearend), coredata(df_yearend)) %>%
  mutate(
    Year = as.numeric(format(Date, "%Y")),
    Week = 53 # Hard-code as the final bucket
  )

# --- STEP D: Combine and Calculate ---
df_combined <- bind_rows(df_weekly, df_yearend) %>%
  arrange(Year, Week)

# Join with the NEW Correct Baselines
df_plot <- left_join(df_combined, df_baselines, by = "Year") %>%
  mutate(
    # Standard YTD Calculation: (Current Price / Previous Year Close) - 1
    change_from_year_start = ((`IXIC.Adjusted` / Baseline_Price) - 1) * 100
  )

# Split and Average
df_hist_plain <- df_plot %>% filter(Year < current_year)
df_curr_year  <- df_plot %>% filter(Year == current_year)

df_avg <- df_hist_plain %>%
  group_by(Week) %>%
  summarise(avg_change = mean(change_from_year_start, na.rm = TRUE))

# --- STEP E: Plotting ---
p <- plot_ly()

# Historical Years
p <- add_trace(p, 
               data = df_hist_plain,
               x = ~Week, 
               y = ~change_from_year_start,
               type = 'scatter', 
               mode = 'lines', 
               split = ~Year, 
               line = list(color = 'grey', width = 1),
               opacity = 0.3,
               hoverinfo = "text",
               text = ~paste("Year:", Year, "<br>Week:", Week, "<br>Change:", round(change_from_year_start, 1),"%"),
               showlegend = FALSE)

# Current Year
if(nrow(df_curr_year) > 0) {
  p <- add_trace(p, 
                 data = df_curr_year,
                 x = ~Week, 
                 y = ~change_from_year_start,
                 type = 'scatter', 
                 mode = 'lines',
                 line = list(color = '#336699', width = 3),
                 name = as.character(current_year),
                 hoverinfo = "text",
                 text = ~paste("Year:", Year, "<br>Week:", Week, "<br>Change:", round(change_from_year_start, 1),"%"))
}

# Average Line
p <- add_trace(p, 
               data = df_avg,
               x = ~Week, 
               y = ~avg_change,
               type = 'scatter', 
               mode = 'lines',
               line = list(color = 'darkred', width = 2, dash = 'dot'),
               name = "Average 2018-2024",
               hoverinfo = "text",
               text = ~paste("Average", "<br>Week:", Week, "<br>Change:", round(avg_change, 1),"%"))

# Layout
p <- p %>% layout(
  xaxis = list(
    title = "Week",
    range = c(0.5, 53.5),
    showgrid = FALSE,
    tickvals = c(1, 10, 20, 30, 40, 50),
    ticktext = c("1", "10", "20", "30", "40", "50")
  ),
  yaxis = list(title = "% Change", showgrid = TRUE, gridcolor = "#e5e5e5"),
  showlegend = TRUE,
  legend = list(orientation = "h", y = 1.1),
  plot_bgcolor = "white"
) %>% config(displayModeBar = FALSE)

p
```
